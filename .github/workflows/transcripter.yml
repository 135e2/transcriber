name: "transcripter"

on:
  workflow_dispatch:
    inputs:
      audioURL:
        description: "Audio file URL"
        required: true
        type: string
      targetLanguage:
        description: "The target language for translation, default is zh (Chinese)"
        default: "zh"
        type: string
      translateProvider:
        description: "The translate provider for translation, default is caiyun"
        default: "caiyun"
        type: string

jobs:
  transcript:
    name: "Transcript"
    runs-on: ubuntu-latest
    container: ${{ github.repository }}:master
    env:
      audioURL: ${{ inputs.audioURL }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      - name: Update Archlinux repo
        run: pacman -Syu --noconfirm noto-fonts-cjk
      - name: Download audio file
        run: |
          mkdir -p workdir
          cd workdir
          echo "Downloading audio..."
          filename=$(curl -sJOL ${audioURL} -w "%{filename_effective}")
          filename_base=${filename%.*}
          echo "filename=${filename}" >> $GITHUB_ENV
          echo "filename_base=${filename_base}" >> $GITHUB_ENV
          echo "Downloaded file: ${filename}"
      - name: Whisper!
        working-directory: ./workdir
        run: |
          whisper --model base ${{ env.filename }}
      - name: Translate srt subtitles
        working-directory: ./workdir
        run: |
          echo "Installing deps..."
          pip install -r ../scripts/requirements.txt
          echo "Translating..."
          python3 ../scripts/translate.py -tl ${{ inputs.targetLanguage }} -tp ${{ inputs.translateProvider }} ${{ env.filename }}.srt
      - name: Generate videos with/without subtitle
        working-directory: ./workdir
        run: |
          echo "Generating videos using ffmpeg..."
          ffmpeg -f lavfi -i color=c=black:s=1920x1080:r=5 -i ${{ env.filename }} -crf 0 -c:a copy -shortest ${{ env.filename_base }}.mp4
          ffmpeg -i ${{ env.filename_base }}.mp4 -vf subtitles=${{ env.filename }}_${{ inputs.targetLanguage }}-${{ inputs.translateProvider }}.srt ${{ env.filename_base }}-sub.mp4
          cd ..
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          path: workdir/
          name: ${{ env.filename_base }}
